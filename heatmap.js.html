<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Leaflet Heatmap Layer Plugin</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      body * {
        font-family: sans-serif;
        font-weight: 200;
      }
      #map {
        height: 100%;
      }
      .leaflet-container {
        background: rgba(0, 0, 0, 0.8) !important;
      }
      .leaflet-popup-content {
        width: auto !important;
      }
      h1 {
        position: absolute;
        background: black;
        color: white;
        padding: 10px;
        font-weight: 200;
        z-index: 10000;
        margin-top: 70px;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <script>
      function setup() {
        var map;
        var baseLayer = L.tileLayer(
          // https://wiki.openstreetmap.org/wiki/Tile_servers
          "https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png	",
          {
            attribution:
              'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
            maxZoom: 18
          }
        );

        var geojsonMarkerOptions = {
          radius: 2,
          fillColor: "#fff",
          // color: "#000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        };

        var geoLayer = L.geoJson([], {
          pointToLayer: (feature, latlng) =>
            L.circleMarker(latlng, geojsonMarkerOptions),
          onEachFeature: function(feature, layer) {
            var popupText =
              `<b>Id:</b> ${feature.properties.id}<br><b>Views:</b> ${feature.properties.views}<br><img src="${feature.properties.url_s}">`;

            layer.bindPopup(popupText, {
              closeButton: true,
              offset: L.point(0, -20)
            });
            layer.on("click", function() {
              layer.openPopup();
            });
          }
        });

        var heatmapLayer = L.heatLayer([], { radius: 30 });

        map = new L.Map("map", {
          center: new L.LatLng(1.356661, 103.830857),
          zoom: 12,
          layers: [baseLayer, heatmapLayer, geoLayer]
        });

        return { heatmapLayer, geoLayer };
      }

      // https://www.flickr.com/services/api/flickr.photos.search.htm
      // https://www.flickr.com/services/api/explore/flickr.photos.search
      async function loadPhotos(page = 1) {
        const params = Object.entries({
          api_key: '407902b4e99781ae7d33552db35a119c',
          bbox: '103.63123,1.180947,104.040871,1.458106',
          extras: 'date_taken,geo,url_s,views',
          min_taken_date: new Date(2018, 0, 1).getTime() / 1000,
          max_taken_date: new Date(2019, 0, 1).getTime() / 1000,
          per_page: '500',
          sort: 'interestingness-desc'
        }).map(([key, value]) => `${key}=${value}`).join('&');
        const flickrPhotos = await fetch(
          `https://api.flickr.com/services/rest/?method=flickr.photos.search&${params}&format=json&nojsoncallback=1`
        ).then(data => data.json());
        return flickrPhotos.photos.photo;
      }

      async function run({ heatmapLayer, geoLayer }, cycles) {
        for (let cycle = 0; cycle < cycles; cycle++) {
          const photos = await loadPhotos(cycle);
          var geojsonFeatures = photos.map(photo => ({
            type: "Feature",
            properties: {
              views: photo.views,
              url_s: photo.url_s
            },
            geometry: {
              type: "Point",
              coordinates: [photo.longitude, photo.latitude]
            }
          }));

          geoLayer.addData(geojsonFeatures);

          var locations = geojsonFeatures.forEach(feature =>
            heatmapLayer.addLatLng([
              ...feature.geometry.coordinates.reverse(),
              0.5
            ])
          );
        }
      }

      window.onload = function() {
        const layers = setup();
        run(layers, 10);
      };
    </script>
  </head>
  <body>
    <h1>Leaflet</h1>
    <div id="map"></div>
  </body>
</html>
